<h2 id="overview">Overview</h2>

<p>Sunbird software is containerized. The installation script uses the Docker swarm orchestration engine to run the Sunbird docker images. The Docker swarm consists of manager and agent nodes. The containers are run on the agent nodes and the manager nodes manage the container lifecycle.</p>

<p>All the stateless services in Sunbird - Portal, LMS Backend, API Gateway and Proxies - are run as docker containers inside the swarm. All stateful services consisting of Cassandra, PostgreSql, Elasticsearch and the OAuth service(Keycloak) are run on Virtual Machines (VMs) directly. The installation is automated using shell scripts and Ansible.</p>

<p>This page provides you with information on the prerequisites and the sequence of steps to install Sunbird.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>
    <p>Minimum 2 servers with 7 GB RAM, running Ubuntu server 16.04 LTS. You can scale the infrastructure by adding servers. Sunbird is designed to scale horizontally. The servers should connect to each other over TCP on the following <a href="developer-docs/installation/server_installation/#mapping-ports">ports</a> The scripts do not work on virtual machines created locally (using VMware/VirtualBox) and have been tested on Azure and AWS VMs.</p>
  </li>
  <li>
    <p>Recommended that you have a domain name and a valid SSL certificate for the domain. If you do not have a domain name, you can configure Sunbird such that it can be accessed over an IP address. If you have a domain name, and you want to get an SSL certificate, refer <a href="https://letsencrypt.org/" target="_blank">Let’s Encrypt</a> to generate a free certificate which is valid for 90 days.</p>
  </li>
  <li>
    <p>Sunbird requires EkStep API keys to access the EkStep content repository. Follow the steps <a href="http://www.sunbird.org/developer-docs/telemetry/authtokengenerator_jslibrary/#how-to-generate-authorization-credentials" target="_blank">here</a> to get the keys. If you are creating a test environment, get the QA API keys.</p>
  </li>
  <li>
    <p>Create a common linux user (e.g. deployer) on all the servers. Configure this user to use <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server" target="_blank">key based ssh</a>. Use an empty passphrase while generating the ssh key to avoid password prompts during installation. Since the installation script uses this key (user) to deploy Sunbird, this user must have <strong>sudo</strong> access on the servers.</p>
  </li>
  <li>
    <p>Create an <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-create-storage-account" target="_blank">Azure storage account</a> to complete the Sunbird installation. This account is used to store QR code images and achievement badges.</p>
  </li>
  <li>
    <p>The following table lists the services that are set up and run as part of installation. The table also lists the optimal server count for a typical staging or production environment with thousands of users.</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">Server Name</th>
          <th style="text-align: left">Suggested Servers per Environment</th>
          <th style="text-align: left">Basic Requirement</th>
          <th style="text-align: left">Maximum Servers</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left">Docker swarm manager<sup>1</sup></td>
          <td style="text-align: left">Staging - 1 <br /> Prod - 3</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 2GB</td>
          <td style="text-align: left">Any</td>
        </tr>
        <tr>
          <td style="text-align: left">Docker swarm  agent nodes<sup>1</sup></td>
          <td style="text-align: left">Staging - 1 <br /> Prod - 3</td>
          <td style="text-align: left">CPU: 2core &amp; RAM: 6GB</td>
          <td style="text-align: left">Any</td>
        </tr>
        <tr>
          <td style="text-align: left">Elasticsearch<sup>2</sup></td>
          <td style="text-align: left">Staging - 1 <br /> Prod- 3</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 3GB</td>
          <td style="text-align: left">Any</td>
        </tr>
        <tr>
          <td style="text-align: left">Postgres master<sup>2</sup></td>
          <td style="text-align: left">Staging&amp;Prod - 1</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 3GB</td>
          <td style="text-align: left">1</td>
        </tr>
        <tr>
          <td style="text-align: left">Postgres slave<sup>2</sup></td>
          <td style="text-align: left">Staging&amp;Prod - 1</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 3GB</td>
          <td style="text-align: left">1</td>
        </tr>
        <tr>
          <td style="text-align: left">Cassandra<sup>2</sup></td>
          <td style="text-align: left">Staging&amp;Prod - 1</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 3GB</td>
          <td style="text-align: left">1</td>
        </tr>
        <tr>
          <td style="text-align: left">Keycloak<sup>1</sup></td>
          <td style="text-align: left">Staging&amp;Prod - 1</td>
          <td style="text-align: left">CPU: 1core &amp; RAM: 4GB</td>
          <td style="text-align: left">Any</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>When you install Sunbird on 2 servers, all services with a common superscript (e.g. servername<sup>2</sup>) for the Server Name are run on the same server. The App server runs services with superscript <sup>1</sup> and the DB server runs services with superscript <sup>2</sup>.</p>
  </li>
</ul>

<h4 id="mapping-ports">Mapping Ports</h4>

<p>The following is a list of ports that must be open:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">From server</th>
      <th style="text-align: left">To server</th>
      <th style="text-align: left">port</th>
      <th style="text-align: left">protocol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Administration server</td>
      <td style="text-align: left">All servers</td>
      <td style="text-align: left">22</td>
      <td style="text-align: left">TCP</td>
    </tr>
    <tr>
      <td style="text-align: left">ELB/Internet</td>
      <td style="text-align: left">0.0.0.0</td>
      <td style="text-align: left">80,443</td>
      <td style="text-align: left">TCP</td>
    </tr>
    <tr>
      <td style="text-align: left">swarm managers subnet</td>
      <td style="text-align: left">swarm nodes subnet</td>
      <td style="text-align: left">All</td>
      <td style="text-align: left">TCP &amp; UDP</td>
    </tr>
    <tr>
      <td style="text-align: left">swarm nodes</td>
      <td style="text-align: left">Cassandra servers</td>
      <td style="text-align: left">9042</td>
      <td style="text-align: left">TCP</td>
    </tr>
    <tr>
      <td style="text-align: left">swarm nodes</td>
      <td style="text-align: left">Elasticsearch servers</td>
      <td style="text-align: left">9200</td>
      <td style="text-align: left">TCP</td>
    </tr>
    <tr>
      <td style="text-align: left">swarm nodes</td>
      <td style="text-align: left">Postgres servers</td>
      <td style="text-align: left">5432</td>
      <td style="text-align: left">TCP</td>
    </tr>
    <tr>
      <td style="text-align: left">swarm nodes</td>
      <td style="text-align: left">Keycloak</td>
      <td style="text-align: left">8080</td>
      <td style="text-align: left">TCP</td>
    </tr>
  </tbody>
</table>

<p><strong>Note:</strong> If you setup more than one swarm agent node, you will need to configure a load balancer to spray the incoming requests to all the agent nodes. All agent nodes in a swarm route the request to the right service.</p>

<h2 id="supported-application-versions">Supported application versions</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Application</th>
      <th style="text-align: left">Version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Docker</td>
      <td style="text-align: left">17.06, 18.03</td>
    </tr>
    <tr>
      <td style="text-align: left">Elasticsearch</td>
      <td style="text-align: left">5.4</td>
    </tr>
    <tr>
      <td style="text-align: left">Postgres</td>
      <td style="text-align: left">9.5</td>
    </tr>
    <tr>
      <td style="text-align: left">Cassandra</td>
      <td style="text-align: left">3.9</td>
    </tr>
  </tbody>
</table>

<h2 id="installation-procedure">Installation Procedure</h2>

<p><strong>Note:</strong> Choose one docker swarm manager VM as the installation server and execute the following steps from that server. If you are installing Sunbird on two servers, execute the steps from the app server.</p>

<ol>
  <li>
    <p>Install git using <code>sudo apt-get update -y &amp;&amp; sudo apt-get install git -y </code></p>
  </li>
  <li>
    <p>Run <code>git clone https://github.com/project-sunbird/sunbird-devops.git</code></p>
  </li>
  <li>
    <p><code>cd sunbird-devops</code></p>
  </li>
  <li>
    <p>Checkout the latest release branch <code>git checkout tags/release-1.8.2 -b release-1.8.2</code></p>
  </li>
  <li>
    <p><code>cd deploy</code></p>
  </li>
  <li>
    <p>Update the configuration parameters in the <code>config</code> file.</p>
  </li>
</ol>

<p>The configuration parameters are explained in the following table:</p>

<table>
  <thead>
    <tr>
      <th>Variable Name</th>
      <th>Description</th>
      <th>Mandatory</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>env</strong></td>
      <td>The environment name being deployed. For example; development, test, staging, production, etc.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>implementation_name</strong></td>
      <td>Name of your sunbird implementation.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>ssh_ansible_user</strong></td>
      <td>The SSH user name that has sudo access to all servers.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>ansible_private_key_path</strong></td>
      <td>The path of the private SSH key file for the ssh_ansible_user. Ansible uses this file to SSH to the servers.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>dns_name</strong></td>
      <td>The domain name or IP address of your installation. Provide the IP address, if want to access Sunbird over a network or if you do not have a domain name.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>proto</strong></td>
      <td>The protocol to be used. This is either http or https. Use http if the value of the <strong>dns_name</strong> variable is an IP address or if you have a domain but do not want SSL for trials.</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>cert_path</strong></td>
      <td>Path to the .cert file in the SSL certificate for nginx. This variable is not mandatory, if the value of the <strong>proto</strong> variable is set to http.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>key_path</strong></td>
      <td>Path to .key file  in the SSL certificate for nginx. This variable is not mandatory, if the value of the <strong>proto</strong> variable is set to http.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>ekstep_api_key</strong></td>
      <td>The JWT token generated by the key,secret produced from Ekstep</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><a href="developer-docs/configuring_sunbird/sso_publickey" target="_blank">sso_password</a></td>
      <td>The password for the keycloak SSO user. The default user is <strong>user-manager</strong>. You can change it from the Keycloak GUI</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>keycloak_admin_password</strong></td>
      <td>The Keycloak admin console password. The default admin username is <strong>admin</strong>. You can change it from the Keycloak GUI</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>trampoline_secret</strong></td>
      <td>The trampoline secret for Keycloak. The secret must be a minimum of 8 characters</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>app_address_space</strong></td>
      <td>The application server address space. For example, 10.3.0.0/24)</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>ekstep_api_base_url</strong></td>
      <td>The base URL for all EkStep APIs. The URL for staging is: https://qa.ekstep.in/api and production is: https://api.ekstep.in</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>ekstep_proxy_base_url</strong></td>
      <td>The proxy URL for EkStep. The URL for staging is: https://qa.ekstep.in  and production: https://community.ekstep.in</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>sudo_passwd</strong></td>
      <td>The sudo password. If the ansible user has one, the value should be specified here. The sudo password should be the same for all servers. Else, the parameter can be blank.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>database_host</strong></td>
      <td>The private IP address of the DB server</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>database_password</strong></td>
      <td>The common password for all the databases</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>elasticsearch_host</strong></td>
      <td>A comma-separated (,) list of Elasticsearch database IP addresses.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>cassandra_host</strong></td>
      <td>The IP address of the Cassandra database.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>postgres_master_host</strong></td>
      <td>The IP address of the Postgres master database</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>postgres_slave_host</strong></td>
      <td>The IP address of the Postgres slave database. If you do not need a slave node, specify the IP address of the master.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>swarm_manager_host</strong></td>
      <td>A comma-separated (,) list of the IP addresses of swarm managers.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>swarm_node_host</strong></td>
      <td>A comma-separated (,) list of swarm node IP addresses .</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>keycloak_host</strong></td>
      <td>A comma-separated (,) list of Keycloak IP addresses.</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>sunbird_azure_storage_account</strong></td>
      <td>The Azure storage account for the badger service</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>sunbird_azure_storage_key</strong></td>
      <td>The Azure storage key for the badger service</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>sunbird_image_storage_url</strong></td>
      <td>The Azure image url for the badger service</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>sunbird_installation_email</strong></td>
      <td>The Sunbird installation email ID</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>sunbird_telemetry_pdata_id</strong></td>
      <td>The Sunbird telemetry pdata ID, for example <br /> {env}.{implimentation_name}.learning.service</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>backup_storage_key</strong></td>
      <td>The storage key for the Elasticsearch backup</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>badger_admin_password</strong></td>
      <td>The password for the badger administrator</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>badger_admin_email</strong></td>
      <td>The email ID of the badger administrator</td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>mail_server_host</strong></td>
      <td>The ID of the mail server host used to send alerts</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>mail_server_port</strong></td>
      <td>mail server port used by mail server for alerting</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>mail_server_username</strong></td>
      <td>username of mail</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>mail_server_password</strong></td>
      <td>password of mail</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>vault_postgres_exporter_password</strong></td>
      <td>postgres vault exporter password</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>grafana_admin_password</strong></td>
      <td>password for grafana dashboard</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>monitor_alerts_slack_url</strong></td>
      <td>slack app webhook url</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>monitor_alerts_slack_channel</strong></td>
      <td>list of emails to send alerts</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>vault_proxy_prometheus_admin_creds</strong></td>
      <td>prometheus admin password</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>proxy_prometheus</strong></td>
      <td>Setting up Prometheus Proxy</td>
      <td>no</td>
    </tr>
    <tr>
      <td><strong>sunbird_sso_publickey</strong></td>
      <td>For creation of User, http://<dns_name>/auth -&gt; realm settings -&gt; keys -&gt; public keys (click on public keys) and paste the value</dns_name></td>
      <td>yes</td>
    </tr>
    <tr>
      <td><strong>sunbird_default_channel</strong></td>
      <td>channel name with which you are creating the organization</td>
      <td>yes</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>Run the script <code>./sunbird_install.sh</code>. This script sets up the infra setup from  stage 1 to stage 6 in a sequence as mentioned in the following table:</li>
</ol>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Stage no</th>
      <th style="text-align: left">Stage name</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">config</td>
      <td style="text-align: left">Generates configuration file and hosts file</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">dbs</td>
      <td style="text-align: left">Installs all databases and creates schema</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">apis</td>
      <td style="text-align: left">Sets up API manager kong and Onboard API’s and consumer’s</td>
    </tr>
    <tr>
      <td style="text-align: left">4</td>
      <td style="text-align: left">proxy</td>
      <td style="text-align: left">Deploys and configures Nginx</td>
    </tr>
    <tr>
      <td style="text-align: left">5</td>
      <td style="text-align: left">keycloak</td>
      <td style="text-align: left">Deploys and configures Keycloak</td>
    </tr>
    <tr>
      <td style="text-align: left">6</td>
      <td style="text-align: left">badger</td>
      <td style="text-align: left">Deploys the badger service</td>
    </tr>
    <tr>
      <td style="text-align: left">7</td>
      <td style="text-align: left">core</td>
      <td style="text-align: left">Deploys all core services</td>
    </tr>
  </tbody>
</table>

<p><br /><b>Note:</b> The badger service does not work without an Azure storage account name and key.</p>

<ol>
  <li>Get the public key from keycloak **http://<dns_name or="" IP="">/auth -&gt; Administration console -&gt; realm settings -&gt; keys -&gt; public keys** (click on public keys) and set it for `sunbird_sso_publickey` parameter in `config` file. Now, execute the command `./sunbird_install.sh -s core` to redeploy the core services.</dns_name></li>
</ol>

<p><br /><b>Note:</b> &lt;li&gt; If you want to re-run particular stage in the installation, execute <code>./sunbird_install.sh -s &lt;stage name&gt;</code> &lt;/li&gt;</p>

<li>To know more about the script `sunbird_install.sh` [refer](developer-docs/installation/server_installation/#sunbird-install-script) to the section [below](developer-docs/installation/server_installation/#sunbird-install-script).</li>

<h2 id="post-installation-configuration">Post Installation Configuration</h2>

<ol>
  <li><strong>Create user access token</strong> - To create a user access token you should execute the following cURL:</li>
</ol>

<pre>
curl -X POST {dns_name}/auth/realms/sunbird/protocol/openid-connect/token \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/x-www-form-urlencoded' \
  -d 'client_id=admin-cli&amp;username=user-manager&amp;password={password}&amp;grant_type=password'
</pre>
<p>The values in the { } braces should be replaced with your environment values
- {dns_name} - Domain or the IP address of your application server.
- {password} - Password of the <code>user-manager</code> user. The one you have provided for <code>sso_password</code> parameter in the <code>config</code> file above.</p>

<ol>
  <li><strong>Create root organization</strong> - To create a root organization you should the following cURL:</li>
</ol>

<pre>
curl -X POST  \
  {dns_name}/api/org/v1/create \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json' \
  -H 'accept: application/json' \
  -H 'authorization: Bearer {jwt token from ~/jwt_token_player.txt}' \
  -H 'x-authenticated-user-token: {access token created last step}' \
  -d '{
  "request":{
     "orgName": "{Your Organization Name}",
     "description": "{Your organization description}",
     "isRootOrg":true,
     "channel":"{Your Channel Name}"
    }
   }'
</pre>
<p><strong>Note:</strong> Channel should be a unique name across Sunbird instances who are using the EkStep content repository</p>

<ol>
  <li>
    <p>Update <code>sunbird_default_channel</code> in the <code>config</code> file with <strong>{Your Channel Name}</strong> (that was created in previous step) and re-run the command <code>./sunbird_install.sh -s core</code></p>
  </li>
  <li>
    <p>Run <code>./sunbird_install.sh -s posttest</code>, to validate all the services for a successful installation. On executing the script, a file <strong>postInstallationLogs.log</strong> in the <strong>logs</strong> directory will be created.</p>
  </li>
  <li>
    <p>Open <strong>https://[domain-name]</strong> and sign up.</p>
  </li>
  <li>
    <p>You may choose your own user name and password. The format for the username while login is: username@channelName</p>
  </li>
</ol>

<h2 id="sunbird-install-script">Sunbird Install Script</h2>

<p>The Sunbird installation script <code>./sunbird_install.sh</code> is a wrapper shell script that invokes other scripts or Ansible playbooks. It fetches all the docker images from the Sunbird DockerHub repository.</p>

<ul>
  <li>
    <p><code>sanity.sh</code> - Basic Sunbird prerequisites check.</p>
  </li>
  <li>
    <p><code>install-deps.sh</code> - Installs Ansible v2.4.1.0 on the installation server to provision and deploy Sunbird. This script also sets up the docker swarm.</p>
  </li>
  <li>
    <p><code>generate_config.sh</code> - Creates a workspace for the installation and sets up necessary config files.</p>
  </li>
  <li>
    <p><code>generate_hosts.sh</code> - Creates a hosts file (Ansible file format) dynamically to run the Ansible scripts.</p>
  </li>
  <li>
    <p><code>install-dbs.sh</code> - Installs Cassandra, Elasticsearch and Postgres databases.</p>
  </li>
  <li>
    <p><code>init-dbs.sh</code> - Sets up the required schema for Cassandra, Elasticsearch and Postgres databases.</p>
  </li>
  <li>
    <p><code>deploy-apis.sh</code> - Deploys the api gateway (Kong) as a docker service using Ansible.</p>
  </li>
  <li>
    <p><code>deploy-proxy.sh</code> - Deploys the proxy (Nginx) as a docker service.</p>
  </li>
  <li>
    <p><code>provision-keycloak.sh</code> - Installs Keycloak.</p>
  </li>
  <li>
    <p><code>deploy-keycloak-vm.sh</code> - Deploys the OAuth service (Keycloak) on the VM. The Keycloak service runs outside the swarm.</p>
  </li>
  <li>
    <p><code>bootstrap-keycloak.sh</code> - Imports the auth realm and configures Keycloak.</p>
  </li>
  <li>
    <p><code>deploy-badger.sh</code> - Deploys the badger service as docker service.</p>
  </li>
  <li>
    <p><code>deploy-core.sh</code> - Deploys the core services player, content, actor and learner service as docker services. The content, actor and learner service together form the LMS backend.</p>
  </li>
</ul>
